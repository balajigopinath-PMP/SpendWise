<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendWise</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop-Types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
      .custom-scrollbar::-webkit-scrollbar { width: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      .animate-fade-in { animation: fadeIn 0.5s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;
      const Recharts = window.Recharts || {
        PieChart: () => null, Pie: () => null, Cell: () => null, 
        BarChart: () => null, Bar: () => null, XAxis: () => null, YAxis: () => null, 
        CartesianGrid: () => null, Tooltip: () => null, Legend: () => null, 
        ResponsiveContainer: ({children}) => <div>{children}</div>, LineChart: () => null, Line: () => null
      };
      const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar, Legend } = Recharts;

      // --- Icons ---
      const IconWrapper = ({ children, className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
      
      // Navigation Icons
      const LayoutDashboard = ({className}) => <IconWrapper className={className}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconWrapper>;
      const Wallet = ({className}) => <IconWrapper className={className}><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></IconWrapper>;
      const Plane = ({className}) => <IconWrapper className={className}><path d="M2 12h20"/><path d="M13 2l9 10-9 10"/><path d="m2 12 5-5m-5 5 5 5"/></IconWrapper>;
      const PieChartIcon = ({className}) => <IconWrapper className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconWrapper>;
      const Settings = ({className}) => <IconWrapper className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
      const Plus = ({className}) => <IconWrapper className={className}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;
      const CreditCard = ({className}) => <IconWrapper className={className}><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></IconWrapper>;
      const TrendingUp = ({className}) => <IconWrapper className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
      const TrendingDown = ({className}) => <IconWrapper className={className}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconWrapper>;
      const ArrowRightLeft = ({className}) => <IconWrapper className={className}><path d="m16 3 4 4-4 4"/><path d="M20 7H4"/><path d="m8 21-4-4 4-4"/><path d="M4 17h16"/></IconWrapper>;
      const Trash2 = ({className}) => <IconWrapper className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
      const LogOut = ({className}) => <IconWrapper className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>;
      const Menu = ({className}) => <IconWrapper className={className}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>;
      const X = ({className}) => <IconWrapper className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>;
      const ChevronRight = ({className}) => <IconWrapper className={className}><path d="m9 18 6-6-6-6"/></IconWrapper>;
      const Info = ({className}) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></IconWrapper>;
      const Filter = ({className}) => <IconWrapper className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></IconWrapper>;

      // Specific Category Icons
      const PiggyBank = ({className}) => <IconWrapper className={className}><path d="M19 5c-1.5 0-2.8 0.6-3.5 1.5-1.1 1.5-2 2.4-2.5 2.5-0.9 0.2-1.9-0.3-2.3-1.1-0.7-1.4-0.4-3 0.6-4 0.6-0.6 1.5-0.9 2.4-0.9 0.9 0 1.7 0.3 2.3 0.9"/><path d="M19 5c1.8 0 3.4 0.9 4.4 2.3 0.3 0.4 0.5 0.9 0.5 1.4 0 0.9-0.7 1.6-1.6 1.6h-1.1c-0.5 0-1-0.2-1.3-0.6l-0.5-0.5"/><path d="M16 15v4"/><path d="M8 15v4"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/><path d="M3.6 9c-0.3 0.9-0.5 1.9-0.5 3 0 4.4 3.6 8 8 8s8-3.6 8-8c0-1.3-0.3-2.5-0.8-3.6"/></IconWrapper>;
      const Briefcase = ({className}) => <IconWrapper className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>;
      const Laptop = ({className}) => <IconWrapper className={className}><path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"/></IconWrapper>;
      const Gift = ({className}) => <IconWrapper className={className}><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.9 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></IconWrapper>;
      const Utensils = ({className}) => <IconWrapper className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></IconWrapper>;
      const ShoppingCart = ({className}) => <IconWrapper className={className}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconWrapper>;
      const Zap = ({className}) => <IconWrapper className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;
      const ShoppingBag = ({className}) => <IconWrapper className={className}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></IconWrapper>;
      const Film = ({className}) => <IconWrapper className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></IconWrapper>;
      const Activity = ({className}) => <IconWrapper className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></IconWrapper>;
      const Book = ({className}) => <IconWrapper className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconWrapper>;
      const Home = ({className}) => <IconWrapper className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>;
      const Car = ({className}) => <IconWrapper className={className}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M5 17h2"/><path d="M15 17h2"/></IconWrapper>;
      const Bike = ({className}) => <IconWrapper className={className}><circle cx="5.5" cy="17.5" r="3.5"/><circle cx="18.5" cy="17.5" r="3.5"/><path d="M15 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-3 11.5V14l-3-3 4-3 2 3h2"/><path d="M9.5 17.5 5.5 14"/></IconWrapper>;
      const User = ({className}) => <IconWrapper className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>;
      const Smartphone = ({className}) => <IconWrapper className={className}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconWrapper>;
      const FileText = ({className}) => <IconWrapper className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconWrapper>;
      const BarChart2 = ({className}) => <IconWrapper className={className}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></IconWrapper>;
      const Disc = ({className}) => <IconWrapper className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
      const RefreshCw = ({className}) => <IconWrapper className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>;
      const Lock = ({className}) => <IconWrapper className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconWrapper>;
      const Bitcoin = ({className}) => <IconWrapper className={className}><path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.215-6.893m-1.215 6.893-3.94-.694m5.155-6.2L8.279 5.307m6.153 1.085-.348 1.974m-8.658-2.6L2.6 7.537m5.679-.997L6.726 15.51M9.863 3.309l1.974.348m-5.11 15.085 1.973.348"/></IconWrapper>;
      
      const getCategoryIcon = (category) => {
        const map = {
          'Salary': Briefcase, 'Freelance': Laptop, 'Investments': TrendingUp, 'Rental': Home, 'Gift': Gift,
          'Food': Utensils, 'Groceries': ShoppingCart, 'Transport': Car, 'Utilities': Zap, 'Shopping': ShoppingBag,
          'Entertainment': Film, 'Health': Activity, 'Education': Book,
          'House': Home, 'Car': Car, 'Bike': Bike, 'Personal': User, 'Gadgets': Smartphone,
          'Mutual Fund': PieChartIcon, 'Bonds': FileText, 'Stocks': BarChart2, 'Gold': Disc, 'Silver': Disc,
          'Recurring Deposit': RefreshCw, 'Fixed Deposit': Lock, 'Crypto': Bitcoin
        };
        return map[category] || Wallet;
      };

      // --- CONSTANTS & DUMMY DATA ---
      const PRIMARY_COLOR = '#FA715E';
      const SECONDARY_COLOR = '#34495e';
      const TEXT_ON_DARK = '#ecf0f1';
      const BG_LIGHT = '#f8f9fa';
      const COLORS = ['#f59b25', '#2ecc71', '#3498db', '#e74c3c', '#9b59b6', '#f1c40f', '#1abc9c'];
      const CURRENCY = 'â‚¹';

      const generateDummyData = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const d = (day) => `${year}-${month}-${String(day).padStart(2, '0')}`;
        return {
          transactions: [
            { id: 'd1', type: 'income', category: 'Salary', amount: 85000, date: d(1), notes: 'Demo Salary' },
            { id: 'd2', type: 'expense', category: 'Food', amount: 4500, date: d(3), notes: 'Demo Food' },
            { id: 'd3', type: 'expense', category: 'Utilities', amount: 1200, date: d(5), notes: 'Broadband Bill' },
            { id: 'd4', type: 'emi', category: 'Gadgets', amount: 3500, date: d(10), notes: 'Laptop EMI' },
            { id: 'd5', type: 'expense', category: 'Shopping', amount: 2500, date: d(15), notes: 'Sneakers' },
            { id: 'd6', type: 'investment', category: 'Mutual Fund', amount: 5000, date: d(2), notes: 'SIP Demo {{r:12}} (1/12)' }
          ],
          trips: [],
          user: { name: 'Guest User', email: 'guest@example.com', avatar: 'https://ui-avatars.com/api/?name=Guest+User&background=random' }
        };
      };

      const DUMMY_DATA = generateDummyData();

      // --- GAS Bridge ---
      const runGAS = (funcName, ...args) => {
        return new Promise((resolve, reject) => {
          if (typeof google === 'undefined') {
             console.log(`[DEV MODE] Call GAS: ${funcName}`, args);
             if (funcName === 'getTransactions') return resolve(DUMMY_DATA.transactions);
             if (funcName === 'getTrips') return resolve(DUMMY_DATA.trips);
             if (funcName === 'getUserProfile') return resolve(DUMMY_DATA.user);
             return resolve({success:true});
          }
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            [funcName](...args);
        });
      };

      // --- Components ---

      const Sidebar = ({ activeTab, setActiveTab, isMobile, isOpen, setIsOpen, user }) => {
        const menuItems = [
          { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
          { id: 'expenses', label: 'My Finances', icon: Wallet },
          { id: 'trips', label: 'Group Trips', icon: Plane },
          { id: 'reports', label: 'Analytics', icon: PieChartIcon },
          { id: 'profile', label: 'Profile', icon: Settings },
          { id: 'about', label: 'About', icon: Info },
        ];
        const baseClasses = "fixed inset-y-0 left-0 z-50 w-64 shadow-xl transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0";
        const mobileClasses = isOpen ? "translate-x-0" : "-translate-x-full";

        return (
          <React.Fragment>
            {isMobile && isOpen && <div className="fixed inset-0 bg-black bg-opacity-50 z-40" onClick={() => setIsOpen(false)} />}
            <div className={`${baseClasses} ${isMobile ? mobileClasses : ''} flex flex-col`} style={{ backgroundColor: SECONDARY_COLOR, color: TEXT_ON_DARK }}>
              <div className="p-6 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 rounded-lg flex items-center justify-center bg-white">
                    <span className="font-bold text-lg" style={{ color: SECONDARY_COLOR }}>S</span>
                  </div>
                  <span className="text-xl font-bold text-white">SpendWise</span>
                </div>
                {isMobile && <button onClick={() => setIsOpen(false)}><X className="w-6 h-6 text-white" /></button>}
              </div>
              
              <nav className="flex-1 px-4 space-y-2 mt-6">
                {menuItems.map((item) => (
                  <button
                    key={item.id}
                    onClick={() => { setActiveTab(item.id); if (isMobile) setIsOpen(false); }}
                    className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors ${activeTab === item.id ? 'bg-white bg-opacity-10 text-white font-medium border-l-4' : 'text-gray-400 hover:bg-white hover:bg-opacity-5'}`}
                    style={{ borderColor: activeTab === item.id ? PRIMARY_COLOR : 'transparent' }}
                  >
                    <item.icon className="w-5 h-5" style={{ color: activeTab === item.id ? PRIMARY_COLOR : 'inherit' }} />
                    {item.label}
                  </button>
                ))}
              </nav>
              <div className="p-4 border-t border-white/10 mt-auto">
                <div className="flex items-center gap-3">
                  <img src={user?.avatar} alt="User" className="w-10 h-10 rounded-full border-2 border-white" onError={(e) => {e.target.onerror = null; e.target.src="https://ui-avatars.com/api/?name=Guest";}} />
                  <div className="flex-1 min-w-0"><p className="text-sm font-medium text-white truncate">{user?.name || 'Loading...'}</p><p className="text-xs text-gray-400 truncate">{user?.email}</p></div>
                </div>
              </div>
            </div>
          </React.Fragment>
        );
      };

      const About = () => (
        <div className="animate-fade-in max-w-2xl mx-auto mt-10">
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center">
            <div className="w-20 h-20 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-6"><span className="text-3xl font-bold">S</span></div>
            <h1 className="text-3xl font-bold text-gray-800 mb-4">About SpendWise</h1>
            <p className="text-gray-600 mb-8 leading-relaxed">SpendWise is your personal finance companion designed to help you track expenses, manage recurring payments like EMIs, handle group trip settlements, and visualize your financial health with powerful analytics.</p>
            <div className="border-t border-gray-100 pt-6"><p className="text-sm text-gray-500 mb-1">Developed by</p><h3 className="text-xl font-bold text-gray-800">Balaji Gopinath</h3><p className="text-xs text-gray-400 mt-2">Version 1.0.0 â€¢ Built on Google Apps Script</p></div>
          </div>
        </div>
      );

      const Dashboard = ({ transactions, onAddClick, isDemo }) => {
        const now = new Date();
        const safeTransactions = Array.isArray(transactions) ? transactions : [];
        const monthlyTrans = safeTransactions.filter(t => {
          const tDate = new Date(t.date);
          return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
        });
        
        const income = monthlyTrans.filter(t => t.type === 'income').reduce((acc, curr) => acc + Number(curr.amount), 0);
        const expense = monthlyTrans.filter(t => t.type === 'expense').reduce((acc, curr) => acc + Number(curr.amount), 0);
        const emi = monthlyTrans.filter(t => t.type === 'emi').reduce((acc, curr) => acc + Number(curr.amount), 0);
        const investment = monthlyTrans.filter(t => t.type === 'investment').reduce((acc, curr) => acc + Number(curr.amount), 0);
        const savings = income - (expense + emi + investment);

        const categoryData = useMemo(() => {
          const cats = {};
          monthlyTrans.filter(t => t.type === 'expense' || t.type === 'emi' || t.type === 'investment').forEach(t => { 
            const cat = t.category || 'Other';
            cats[cat] = (cats[cat] || 0) + Number(t.amount); 
          });
          return Object.keys(cats).map(k => ({ name: k, value: cats[k] }));
        }, [monthlyTrans]);

        // Calculate breakdown for Investment Tiles in Dashboard
        const investmentData = useMemo(() => {
            const cats = {};
            monthlyTrans.filter(t => t.type === 'investment').forEach(t => {
                cats[t.category] = (cats[t.category] || 0) + Number(t.amount);
            });
            return Object.keys(cats).map(k => ({ name: k, value: cats[k] }));
        }, [monthlyTrans]);

        const StatCard = ({ title, amount, icon: Icon, colorClass }) => (
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col justify-between">
            <div className="flex justify-between items-start mb-4"><div className={`p-3 rounded-xl ${colorClass} bg-opacity-10`}><Icon className={`w-6 h-6 ${colorClass.replace('bg-', 'text-')}`} /></div></div>
            <div><h3 className="text-gray-500 text-sm font-medium mb-1">{title}</h3><p className="text-2xl font-bold text-gray-800">{CURRENCY}{amount.toLocaleString()}</p></div>
          </div>
        );

        return (
          <div className="space-y-6 animate-fade-in">
            {isDemo && (
              <div className="bg-white border-l-4 border-orange-500 p-4 rounded-r-xl shadow-sm mb-6">
                <div className="flex justify-between items-start">
                  <div className="flex gap-4">
                    <span className="text-3xl">ðŸ‘‹</span>
                    <div>
                      <h3 className="font-bold text-gray-800 text-lg">Welcome to SpendWise!</h3>
                      <p className="text-sm text-gray-600 mt-1 max-w-2xl">
                        You are currently viewing <b>Demo Data</b>. To start using the app:
                        <ul className="list-disc ml-5 mt-1 space-y-1">
                          <li>Click the <b>Let's Start</b> button below.</li>
                          <li>This will create a private <b>"SpendWise_Data_v1"</b> spreadsheet in your Google Drive.</li>
                          <li>The demo data will be cleared, and you can start adding your own transactions.</li>
                        </ul>
                      </p>
                    </div>
                  </div>
                  <button 
                    onClick={() => onAddClick('start')} 
                    className="whitespace-nowrap text-white px-6 py-3 rounded-xl font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5" 
                    style={{ backgroundColor: PRIMARY_COLOR }}
                  >
                    Let's Start ðŸš€
                  </button>
                </div>
              </div>
            )}
            <div className="flex flex-wrap justify-between items-center gap-4">
              <h1 className="text-2xl font-bold text-gray-800">Monthly Overview <span className="text-sm font-normal text-gray-500 ml-2">({now.toLocaleString('default', { month: 'long', year: 'numeric' })})</span></h1>
              <div className="flex gap-2 flex-wrap">
                <button onClick={() => onAddClick('expense')} className="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-2 rounded-lg font-medium hover:bg-red-100"><Plus className="w-4 h-4" /> Exp</button>
                <button onClick={() => onAddClick('income')} className="flex items-center gap-2 bg-emerald-50 text-emerald-600 px-4 py-2 rounded-lg font-medium hover:bg-emerald-100"><Plus className="w-4 h-4" /> Inc</button>
                <button onClick={() => onAddClick('emi')} className="flex items-center gap-2 bg-orange-50 text-orange-600 px-4 py-2 rounded-lg font-medium hover:bg-orange-100"><CreditCard className="w-4 h-4" /> EMI</button>
                <button onClick={() => onAddClick('investment')} className="flex items-center gap-2 bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-medium hover:bg-blue-100"><PiggyBank className="w-4 h-4" /> Invest</button>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              <StatCard title="Income" amount={income} icon={TrendingUp} colorClass="bg-emerald-500 text-emerald-600" />
              <StatCard title="Expenses" amount={expense} icon={TrendingDown} colorClass="bg-red-500 text-red-600" />
              <StatCard title="EMI" amount={emi} icon={CreditCard} colorClass="bg-orange-500 text-orange-600" />
              <StatCard title="Investment" amount={investment} icon={PiggyBank} colorClass="bg-blue-500 text-blue-600" />
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-64">
                <ResponsiveContainer width="100%" height="100%">
                  <BarChart data={[{name: 'Current', Income: income, Expense: expense, EMI: emi, Investment: investment}]}>
                    <CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="name" hide /><YAxis /><Tooltip /><Legend />
                    <Bar dataKey="Income" fill="#10b981" radius={[4,4,0,0]} />
                    <Bar dataKey="Expense" fill="#ef4444" radius={[4,4,0,0]} />
                    <Bar dataKey="EMI" fill="#f97316" radius={[4,4,0,0]} />
                    <Bar dataKey="Investment" fill="#3b82f6" radius={[4,4,0,0]} />
                  </BarChart>
                </ResponsiveContainer>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-64">
                <h4 className="text-sm text-gray-500 font-bold mb-2 text-center">Outflow Breakdown</h4>
                <ResponsiveContainer width="100%" height="100%">
                  <PieChart>
                    <Pie 
                      data={categoryData} 
                      innerRadius={50} 
                      outerRadius={70} 
                      paddingAngle={5} 
                      dataKey="value"
                      label={({ value }) => `${CURRENCY}${value}`}
                    >
                        {categoryData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                    </Pie>
                    <Tooltip />
                    <Legend verticalAlign="bottom" height={36} />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Monthly Investment Breakdown Tiles */}
            {investmentData.length > 0 && (
              <div className="mt-6">
                <h3 className="text-lg font-bold text-gray-800 mb-4">Monthly Investment Breakdown</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {investmentData.map((cat) => {
                    const Icon = getCategoryIcon(cat.name);
                    return (
                      <div key={cat.name} className="bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 shadow-sm">
                          <div className="p-3 bg-blue-50 rounded-lg text-blue-600">
                            <Icon className="w-6 h-6" />
                          </div>
                          <div>
                            <p className="text-xs text-gray-500 font-medium">{cat.name}</p>
                            <p className="text-lg font-bold text-gray-800">{CURRENCY}{cat.value.toLocaleString()}</p>
                          </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        );
      };

      // Reports Component
      const Reports = ({ transactions }) => {
        const safeTransactions = Array.isArray(transactions) ? transactions : [];
        const now = new Date();
        
        // Filter transactions for current month ONLY for General Analytics
        const currentMonthTransactions = safeTransactions.filter(t => {
           const tDate = new Date(t.date);
           return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
        });

        // General Analytics (Using Current Month Data)
        const { totalIncome, totalExpense, netSavings, savingsRate, monthlyData, categoryData } = useMemo(() => {
          let tIncome = 0; let tExpense = 0; const months = {}; const cats = {};
          
          currentMonthTransactions.forEach(t => {
            const amount = Number(t.amount);
            const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            
            if (!months[monthKey]) months[monthKey] = { name: monthKey, Income: 0, Expense: 0 };

            if (t.type === 'income') {
              tIncome += amount; months[monthKey].Income += amount;
            } else if (t.type === 'expense' || t.type === 'emi') {
              tExpense += amount; months[monthKey].Expense += amount;
              const cat = t.category || 'Other'; cats[cat] = (cats[cat] || 0) + amount;
            }
          });

          const mData = Object.values(months); 
          const cData = Object.keys(cats).map(key => ({ name: key, value: cats[key] }));
          const nSavings = tIncome - tExpense;
          const sRate = tIncome > 0 ? Math.round((nSavings / tIncome) * 100) : 0;

          return { totalIncome: tIncome, totalExpense: tExpense, netSavings: nSavings, savingsRate: sRate, monthlyData: mData, categoryData: cData };
        }, [currentMonthTransactions]);

        // Investment Analytics (Using ALL TIME Data - safeTransactions)
        const { investmentTotal, investmentReturns, investmentPie, investmentCategories } = useMemo(() => {
          let totalInv = 0;
          let estReturns = 0;
          const cats = {};
          const categoriesBreakdown = {};
          
          safeTransactions.filter(t => t.type === 'investment').forEach(t => {
            const amt = Number(t.amount);
            totalInv += amt;
            
            // Regex for float or int: {{r:12.5}} or {{r:12}}
            const rateMatch = t.notes && t.notes.match(/{{r:([\d.]+)}}/);
            const rate = rateMatch ? parseFloat(rateMatch[1]) : 8; 
            const years = 5; 
            
            const fv = amt * Math.pow((1 + rate/100), years);
            estReturns += (fv - amt);

            cats[t.category] = (cats[t.category] || 0) + amt;
            categoriesBreakdown[t.category] = (categoriesBreakdown[t.category] || 0) + amt;
          });

          const pie = Object.keys(cats).map(k => ({ name: k, value: cats[k] }));
          const catList = Object.keys(categoriesBreakdown).map(k => ({ name: k, value: categoriesBreakdown[k] }));
          return { investmentTotal: totalInv, investmentReturns: Math.round(estReturns), investmentPie: pie, investmentCategories: catList };
        }, [safeTransactions]);

        const KpiCard = ({ title, value, sub, color }) => (
          <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <p className="text-gray-500 text-sm font-medium mb-1">{title}</p>
            <h3 className={`text-2xl font-bold ${color}`}>{CURRENCY}{value.toLocaleString()}</h3>
            <p className="text-xs text-gray-400 mt-2">{sub}</p>
          </div>
        );

        return (
          <div className="space-y-8 animate-fade-in pb-10">
              {/* Investment Section (All Time) */}
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                 <div className="flex items-center gap-2 mb-6"><PiggyBank className="w-6 h-6 text-blue-600" /><h2 className="text-xl font-bold text-gray-800">Investment Portfolio (5 Year Projection)</h2></div>
                 <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div className="col-span-1 flex flex-col justify-center text-center space-y-6">
                        <div>
                          <p className="text-gray-500 text-sm">Projected Value (5 Yrs)</p>
                          <h1 className="text-4xl font-bold text-gray-800">{CURRENCY}{(investmentTotal + investmentReturns).toLocaleString()}</h1>
                        </div>
                        <div className="flex justify-center gap-6 text-left">
                            <div className="border-l-4 border-orange-500 pl-3">
                                <p className="text-xs text-gray-500">Invested Amount</p>
                                <p className="font-bold text-gray-700">{CURRENCY}{investmentTotal.toLocaleString()}</p>
                            </div>
                            <div className="border-l-4 border-blue-500 pl-3">
                                <p className="text-xs text-gray-500">Est. Returns</p>
                                <p className="font-bold text-gray-700">{CURRENCY}{investmentReturns.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    <div className="col-span-2 h-64">
                      {investmentPie.length > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={investmentPie} innerRadius={80} outerRadius={100} paddingAngle={5} dataKey="value" label={({ name, value }) => `${name}: ${CURRENCY}${value}`}>
                                {investmentPie.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}
                            </Pie>
                            <Tooltip formatter={(value) => `${CURRENCY}${value}`} />
                            <Legend layout="vertical" verticalAlign="middle" align="right" />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <div className="h-full flex items-center justify-center text-gray-400 bg-gray-50 rounded-xl">No investments recorded yet</div>
                      )}
                    </div>
                 </div>
                 
                 {/* Investment Category Tiles */}
                 {investmentCategories.length > 0 && (
                   <div className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
                      {investmentCategories.map((cat) => {
                        const Icon = getCategoryIcon(cat.name);
                        return (
                          <div key={cat.name} className="bg-gray-50 p-4 rounded-xl border border-gray-100 flex items-center gap-4">
                             <div className="p-3 bg-white rounded-lg shadow-sm text-blue-600">
                               <Icon className="w-6 h-6" />
                             </div>
                             <div>
                               <p className="text-xs text-gray-500 font-medium">{cat.name}</p>
                               <p className="text-lg font-bold text-gray-800">{CURRENCY}{cat.value.toLocaleString()}</p>
                             </div>
                          </div>
                        );
                      })}
                   </div>
                 )}
              </div>

              {/* General Stats (Current Month) */}
              <div className="flex justify-between items-center"><h1 className="text-2xl font-bold text-gray-800">General Analytics (Current Month)</h1></div>
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <KpiCard title="Total Income" value={totalIncome} sub="This Month" color="text-emerald-600" />
                <KpiCard title="Total Expenses" value={totalExpense} sub="Inc. EMIs" color="text-red-600" />
                <KpiCard title="Net Savings" value={netSavings} sub="Balance" color="text-blue-600" />
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                   <p className="text-gray-500 text-sm font-medium mb-1">Savings Rate</p>
                   <h3 className="text-2xl font-bold text-purple-600">{savingsRate}%</h3>
                   <div className="w-full bg-gray-100 rounded-full h-2 mt-3"><div className="bg-purple-600 h-2 rounded-full" style={{ width: `${Math.max(0, Math.min(100, savingsRate))}%` }}></div></div>
                </div>
              </div>
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h3 className="text-lg font-bold mb-4">Expense Breakdown</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={categoryData} innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value" label={({ value }) => `${CURRENCY}${value}`}>{categoryData.map((entry, index) => (<Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />))}</Pie><Tooltip /><Legend verticalAlign="bottom" /></PieChart></ResponsiveContainer></div></div>
                <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><h3 className="text-lg font-bold mb-4">Income vs Expense</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><BarChart data={monthlyData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="name" /><YAxis /><Tooltip /><Legend /><Bar dataKey="Income" fill="#10b981" radius={[4,4,0,0]} /><Bar dataKey="Expense" fill="#ef4444" radius={[4,4,0,0]} /></BarChart></ResponsiveContainer></div></div>
              </div>
          </div>
        );
      };

      const TripManager = ({ trips, onAddTrip, onAddExpense }) => {
        const [selectedTrip, setSelectedTrip] = useState(null);
        const [showAddExpense, setShowAddExpense] = useState(false);
        const safeTrips = Array.isArray(trips) ? trips : [];

        const calculateBalances = (trip) => {
          const balances = {};
          trip.members.forEach(m => balances[m] = 0);
          trip.expenses.forEach(exp => {
            const split = Number(exp.amount) / trip.members.length;
            trip.members.forEach(m => {
              if (m === exp.paidBy) balances[m] += (Number(exp.amount) - split);
              else balances[m] -= split;
            });
          });
          return balances;
        };

        if (selectedTrip) {
          const balances = calculateBalances(selectedTrip);
          return (
            <div className="animate-fade-in space-y-6">
              <div className="flex items-center gap-4 mb-6"><button onClick={() => setSelectedTrip(null)} className="p-2 hover:bg-gray-100 rounded-full"><ArrowRightLeft className="w-5 h-5" /></button><h2 className="text-2xl font-bold">{selectedTrip.name}</h2><div className="ml-auto"><button onClick={() => setShowAddExpense(true)} className="text-white px-4 py-2 rounded-lg text-sm font-medium" style={{ backgroundColor: PRIMARY_COLOR }}>Add Expense</button></div></div>
              <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100"><h3 className="font-bold mb-4">Balances</h3>{Object.entries(balances).map(([m, amt]) => (<div key={m} className="flex justify-between py-2 border-b last:border-0"><span>{m}</span><span className={amt >= 0 ? 'text-green-600' : 'text-red-600'}>{amt >= 0 ? `Gets ${CURRENCY}${amt.toFixed(0)}` : `Owes ${CURRENCY}${Math.abs(amt).toFixed(0)}`}</span></div>))}</div>
              {showAddExpense && <AddTripExpenseModal members={selectedTrip.members} onClose={() => setShowAddExpense(false)} onSave={(d) => { onAddExpense(selectedTrip.id, d); setShowAddExpense(false); }} />}
            </div>
          );
        }

        return (
          <div className="animate-fade-in">
            <div className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold text-gray-800">Group Trips</h1><button onClick={onAddTrip} className="text-white px-4 py-2 rounded-lg font-medium" style={{ backgroundColor: PRIMARY_COLOR }}><Plus className="w-4 h-4 inline mr-2" /> New Trip</button></div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{safeTrips.map(t => (<div key={t.id} onClick={() => setSelectedTrip(t)} className="bg-white p-5 rounded-2xl shadow-sm border cursor-pointer hover:shadow-md"><div className="flex justify-between mb-4"><div className="p-3 rounded-xl bg-orange-50 text-orange-500"><Plane className="w-6 h-6" /></div><ChevronRight className="text-gray-300" /></div><h3 className="font-bold text-lg">{t.name}</h3><p className="text-sm text-gray-500">{t.members.length} Members</p></div>))}</div>
          </div>
        );
      };

      const TransactionList = ({ transactions, onDelete }) => {
        const [filterDate, setFilterDate] = useState(new Date().toISOString().slice(0, 7));
        const safeTransactions = Array.isArray(transactions) ? transactions : [];
        const filteredTrans = safeTransactions.filter(t => t.date.startsWith(filterDate));

        return (
        <div className="bg-white rounded-2xl shadow-sm border overflow-hidden relative">
          <div className="absolute top-0 right-0 p-2 z-10">
            <input type="month" className="border rounded-lg px-3 py-1 text-sm bg-gray-50 text-gray-700 focus:ring-2 focus:ring-orange-500 outline-none" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} />
          </div>
          <table className="w-full text-left text-sm text-gray-600">
            <thead className="bg-gray-50 border-b"><tr><th className="p-4">Date</th><th className="p-4">Cat</th><th className="p-4">Note</th><th className="p-4 text-right">Amt</th><th className="p-4"></th></tr></thead>
            <tbody>
              {filteredTrans.length > 0 ? filteredTrans.map(t => {
                const Icon = getCategoryIcon(t.category);
                return (
                <tr key={t.id} className="border-b last:border-0 hover:bg-gray-50">
                  <td className="p-4">{t.date}</td>
                  <td className="p-4">
                    <div className="flex items-center gap-2">
                      <div className={`p-2 rounded-lg ${t.type === 'emi' ? 'bg-orange-100 text-orange-800' : (t.type === 'investment' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600')}`}>
                        <Icon className="w-4 h-4" />
                      </div>
                      <span className="font-medium text-gray-700">{t.category}</span>
                    </div>
                  </td>
                  <td className="p-4">{t.notes}</td>
                  <td className={`p-4 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : (t.type === 'investment' ? 'text-blue-600' : 'text-gray-800')}`}>{t.type==='income'?'+':'-'} {CURRENCY}{t.amount}</td>
                  <td className="p-4 text-right"><button onClick={() => onDelete(t.id)} className="text-gray-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></td>
                </tr>
              )}) : (<tr><td colSpan="5" className="p-8 text-center text-gray-400">No records found for this month.</td></tr>)}
            </tbody>
          </table>
        </div>
        );
      };

      const Modal = ({ title, onClose, children }) => (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl animate-fade-in-up"><div className="p-4 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold">{title}</h3><button onClick={onClose}><X className="w-5 h-5" /></button></div><div className="p-6">{children}</div></div></div>
      );

      const AddTransactionModal = ({ type, onClose, onSave }) => {
        const [form, setForm] = useState({ 
          amount: '', category: '', date: new Date().toISOString().split('T')[0], 
          notes: '', type: type || 'expense', tenure: 1, isSIP: false, rate: 8
        });
        
        const categoryOptions = useMemo(() => {
          const defaults = {
            income: ['Salary', 'Freelance', 'Investments', 'Rental', 'Gift'],
            expense: ['Food', 'Groceries', 'Transport', 'Utilities', 'Shopping', 'Entertainment', 'Health', 'Education'],
            emi: ['House', 'Car', 'Bike', 'Personal', 'Gadgets'],
            investment: ['Mutual Fund', 'Bonds', 'Stocks', 'Gold', 'Silver', 'Recurring Deposit', 'Fixed Deposit', 'Crypto']
          };
          return defaults[form.type] || [];
        }, [form.type]);

        const showRecurring = (form.type === 'emi') || (form.type === 'income' && form.category === 'Salary') || (form.type === 'investment' && form.isSIP);
        if (form.type === 'income' && form.category === 'Salary' && form.tenure === 1) setForm(prev => ({...prev, tenure: 12}));

        return (
          <Modal title={`Add ${form.type.toUpperCase()}`} onClose={onClose}>
            <form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="space-y-4">
              {form.type === 'investment' && (
                <div className="flex gap-2 mb-2">
                  <button type="button" onClick={() => setForm({...form, isSIP: false, tenure: 1})} className={`flex-1 py-2 rounded-lg text-sm font-medium border ${!form.isSIP ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500'}`}>One-time</button>
                  <button type="button" onClick={() => setForm({...form, isSIP: true, tenure: 12})} className={`flex-1 py-2 rounded-lg text-sm font-medium border ${form.isSIP ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500'}`}>SIP / Recurring</button>
                </div>
              )}

              <div><label className="text-xs text-gray-500">Amount</label><input required type="number" className="w-full border rounded p-2" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} /></div>
              <div><label className="text-xs text-gray-500">Category</label><input required list="category-options" className="w-full border rounded p-2" value={form.category} onChange={e => setForm({...form, category: e.target.value})} placeholder="Select or type..." /><datalist id="category-options">{categoryOptions.map(cat => <option key={cat} value={cat} />)}</datalist></div>
              
              {showRecurring && (
                <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                   <div className="grid grid-cols-2 gap-2">
                      <div>
                        <label className="text-xs text-blue-600 font-bold block mb-1">Tenure (Months)</label>
                        <input required type="number" min="1" max="360" className="w-full border rounded p-2" value={form.tenure} onChange={e => setForm({...form, tenure: parseInt(e.target.value) || 1})} />
                      </div>
                      {form.type === 'investment' && (
                        <div>
                          <label className="text-xs text-blue-600 font-bold block mb-1">Exp. Return (%)</label>
                          <input required type="number" step="0.01" min="1" max="100" className="w-full border rounded p-2" value={form.rate} onChange={e => setForm({...form, rate: parseFloat(e.target.value) || 0})} />
                        </div>
                      )}
                   </div>
                   <p className="text-[10px] text-blue-400 mt-1">Will generate {form.tenure} entries.</p>
                </div>
              )}
              
              {form.type === 'investment' && !form.isSIP && (
                 <div><label className="text-xs text-gray-500">Exp. Annual Return (%)</label><input required type="number" step="0.01" className="w-full border rounded p-2" value={form.rate} onChange={e => setForm({...form, rate: parseFloat(e.target.value)})} /></div>
              )}

              <div><label className="text-xs text-gray-500">Date</label><input required type="date" className="w-full border rounded p-2" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div>
              <div><label className="text-xs text-gray-500">Notes</label><input className="w-full border rounded p-2" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} /></div>
              <button type="submit" className="w-full text-white py-3 rounded-xl font-medium" style={{ backgroundColor: PRIMARY_COLOR }}>Save</button>
            </form>
          </Modal>
        );
      };

      const AddTripModal = ({ onClose, onSave }) => {
        const [name, setName] = useState(''); const [members, setMembers] = useState('');
        return (
          <Modal title="New Trip" onClose={onClose}><form onSubmit={(e) => { e.preventDefault(); onSave({ name, members: members.split(',').map(m => m.trim()).filter(Boolean) }); }} className="space-y-4"><div><label className="text-xs text-gray-500">Name</label><input required className="w-full border rounded p-2" value={name} onChange={e => setName(e.target.value)} /></div><div><label className="text-xs text-gray-500">Members (comma sep)</label><input required className="w-full border rounded p-2" value={members} onChange={e => setMembers(e.target.value)} /></div><button type="submit" className="w-full text-white py-3 rounded-xl font-medium" style={{ backgroundColor: PRIMARY_COLOR }}>Create</button></form></Modal>
        );
      };

      const AddTripExpenseModal = ({ members, onClose, onSave }) => {
        const [form, setForm] = useState({ description: '', amount: '', paidBy: members[0] || '' });
        const commonTripExpenses = ['Food', 'Cab', 'Tickets', 'Hotel', 'Fuel', 'Snacks', 'Drinks', 'Shopping'];
        return (
          <Modal title="Trip Expense" onClose={onClose}><form onSubmit={(e) => { e.preventDefault(); onSave(form); }} className="space-y-4"><div><label className="text-xs text-gray-500">Desc</label><input required list="trip-expense-options" className="w-full border rounded p-2" value={form.description} onChange={e => setForm({...form, description: e.target.value})} placeholder="e.g., Dinner, Taxi..." /><datalist id="trip-expense-options">{commonTripExpenses.map(item => <option key={item} value={item} />)}</datalist></div><div><label className="text-xs text-gray-500">Amount</label><input required type="number" className="w-full border rounded p-2" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} /></div><div><label className="text-xs text-gray-500">Paid By</label><select className="w-full border rounded p-2 bg-white" value={form.paidBy} onChange={e => setForm({...form, paidBy: e.target.value})}>{members.map(m => <option key={m} value={m}>{m}</option>)}</select></div><button type="submit" className="w-full text-white py-3 rounded-xl font-medium" style={{ backgroundColor: PRIMARY_COLOR }}>Add</button></form></Modal>
        );
      };

      const App = () => {
        const [activeTab, setActiveTab] = useState('dashboard');
        const [transactions, setTransactions] = useState([]);
        const [trips, setTrips] = useState([]);
        const [user, setUser] = useState(null); // New User State
        const [isSidebarOpen, setIsSidebarOpen] = useState(false);
        const [modalType, setModalType] = useState(null);
        const [loading, setLoading] = useState(false);
        const [isDemo, setIsDemo] = useState(true);

        useEffect(() => {
          const fetchData = async () => {
            setLoading(true);
            try {
              const txs = await runGAS('getTransactions');
              const trps = await runGAS('getTrips');
              const userData = await runGAS('getUserProfile');
              
              setTransactions(Array.isArray(txs) ? txs : []);
              setTrips(Array.isArray(trps) ? trps : []);
              setUser(userData); // Set user profile data
              
              if ((!txs || txs.length === 0) && (!trps || trps.length === 0)) setIsDemo(false);
              else setIsDemo(true);
            } catch (e) { console.error(e); }
            setLoading(false);
          };
          fetchData();
        }, []);

        const handleStartReal = async () => {
          setLoading(true);
          await runGAS('clearDatabase');
          setTransactions([]);
          setTrips([]);
          setIsDemo(false);
          setLoading(false);
        };

        const handleSaveTransaction = async (data) => {
          const newTxs = [];
          const isSalary = (data.type === 'income' && data.category === 'Salary');
          const isEMI = (data.type === 'emi');
          
          if ((isEMI || isSalary) && data.tenure > 1) {
            for (let i = 0; i < data.tenure; i++) {
               const dateObj = new Date(data.date);
               dateObj.setMonth(dateObj.getMonth() + i);
               if (isSalary) dateObj.setDate(1);
               const dateStr = dateObj.toISOString().split('T')[0];
               newTxs.push({ 
                 ...data, date: dateStr, id: Date.now() + i, 
                 notes: `${data.notes} (${i+1}/${data.tenure})` 
               });
            }
          } else {
            newTxs.push({ ...data, id: Date.now() });
          }
          setTransactions([...newTxs, ...transactions]);
          await runGAS('addTransaction', data);
          setModalType(null);
        };

        const handleDeleteTransaction = async (id) => {
          setTransactions(transactions.filter(t => t.id !== id));
          await runGAS('deleteTransaction', id);
        };

        const handleAddTrip = async (data) => {
          const newTrip = { ...data, id: Date.now(), expenses: [] };
          setTrips([...trips, newTrip]);
          await runGAS('addTrip', data);
          setModalType(null);
        };

        const handleAddTripExpense = async (tripId, data) => {
          const updatedTrips = trips.map(t => t.id === tripId ? { ...t, expenses: [...t.expenses, { ...data, id: Date.now() }] } : t);
          setTrips(updatedTrips);
          await runGAS('addTripExpense', tripId, data);
        };

        return (
          <div className="flex h-screen font-sans text-gray-900" style={{ backgroundColor: BG_LIGHT }}>
            <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} isMobile={true} isOpen={isSidebarOpen} setIsOpen={setIsSidebarOpen} user={user} />
            <div className="flex-1 flex flex-col overflow-hidden relative">
              <header className="lg:hidden bg-white p-4 border-b flex justify-between items-center sticky top-0 z-30">
                <button onClick={() => setIsSidebarOpen(true)}><Menu className="w-6 h-6 text-gray-700" /></button>
                <span className="font-bold text-lg">SpendWise</span>
                <div className="w-6"></div>
              </header>
              <main className="flex-1 overflow-y-auto p-4 lg:p-8 pb-24 lg:pb-8">
                {loading && <div className="text-center py-4 font-bold text-orange-500">Syncing with Google Sheets...</div>}
                {activeTab === 'dashboard' && <Dashboard transactions={transactions} onAddClick={(type) => type === 'start' ? handleStartReal() : setModalType({ name: 'transaction', type })} isDemo={isDemo} />}
                {activeTab === 'expenses' && (
                  <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center"><h1 className="text-2xl font-bold text-gray-800">Transactions</h1><button onClick={() => setModalType({name: 'transaction', type: 'expense'})} className="text-white px-4 py-2 rounded-lg font-medium" style={{ backgroundColor: PRIMARY_COLOR }}>+ Add New</button></div>
                    <TransactionList transactions={transactions} onDelete={handleDeleteTransaction} />
                  </div>
                )}
                {activeTab === 'trips' && <TripManager trips={trips} onAddTrip={() => setModalType({ name: 'trip' })} onAddExpense={handleAddTripExpense} />}
                {activeTab === 'reports' && <Reports transactions={transactions} />}
                {activeTab === 'profile' && (
                   <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mt-10 text-center">
                      <img src={user?.avatar} className="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-gray-100" />
                      <h2 className="text-2xl font-bold text-gray-800">{user?.name}</h2>
                      <p className="text-gray-500 mb-6">{user?.email}</p>
                      <div className="bg-blue-50 p-4 rounded-xl mb-4"><p className="text-blue-800 font-medium">Hosted on Google Apps Script</p></div>
                      <button className="text-red-500 text-sm hover:text-red-700" onClick={handleStartReal}>Reset All Data</button>
                   </div>
                )}
                {activeTab === 'about' && <About />}
              </main>
            </div>
            {modalType?.name === 'transaction' && <AddTransactionModal type={modalType.type} onClose={() => setModalType(null)} onSave={handleSaveTransaction} />}
            {modalType?.name === 'trip' && <AddTripModal onClose={() => setModalType(null)} onSave={handleAddTrip} />}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>